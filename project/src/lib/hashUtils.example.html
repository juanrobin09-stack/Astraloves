<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test hashUtils - Double # Fix</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        h1 {
            background: linear-gradient(135deg, #ef4444, #f97316);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #9ca3af;
            margin-bottom: 30px;
        }
        .test-section {
            background: #262626;
            border: 1px solid #404040;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section h3 {
            color: #ef4444;
            margin-top: 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 2px solid #404040;
            border-radius: 8px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin: 10px 0;
        }
        button {
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button:active {
            transform: scale(0.98);
        }
        .result {
            background: #1a1a1a;
            border: 2px solid #404040;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        .result.success {
            border-color: #10b981;
        }
        .result.error {
            border-color: #ef4444;
        }
        .log-line {
            margin: 5px 0;
            padding: 5px;
        }
        .log-debug { color: #3b82f6; }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #8b5cf6; }
        .parsed-value {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: #171717;
            border-radius: 6px;
        }
        .parsed-key {
            color: #60a5fa;
            font-weight: bold;
        }
        .parsed-val {
            color: #fbbf24;
        }
        .example-btn {
            background: #374151;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }
        .example-btn:hover {
            background: #4b5563;
        }
    </style>
</head>
<body>
    <h1>üîß Test hashUtils - Double # Fix</h1>
    <p class="subtitle">Test la normalisation des hash URLs malform√©s (double #)</p>

    <div class="test-section">
        <h3>üß™ Test Personnalis√©</h3>
        <p>Entre un hash URL √† tester (avec ou sans le double #) :</p>
        <input type="text" id="customHash" placeholder="#type=recovery#access_token=...&refresh_token=..." />
        <button onclick="testCustomHash()">Tester</button>

        <div style="margin-top: 15px;">
            <strong>Exemples rapides :</strong><br>
            <button class="example-btn" onclick="loadExample(1)">Hash avec double # (Supabase bugu√©)</button>
            <button class="example-btn" onclick="loadExample(2)">Hash correct (un seul #)</button>
            <button class="example-btn" onclick="loadExample(3)">Hash avec plusieurs #</button>
        </div>

        <div id="customResult"></div>
    </div>

    <div class="test-section">
        <h3>üìã Tests Automatiques</h3>
        <button onclick="runAllTests()">Lancer Tous les Tests</button>
        <div id="autoTestResults"></div>
    </div>

    <script>
        // Copie des fonctions de hashUtils.ts
        function normalizeHash(rawHash) {
            console.debug('üîß RAW HASH BEFORE NORMALIZATION:', rawHash);

            let normalized = rawHash;

            // Cas sp√©cifique: #type=recovery#access_token=...
            if (normalized.includes('#type=recovery#')) {
                normalized = normalized.replace('#type=recovery#', '#type=recovery&');
                console.debug('‚úÖ NORMALIZED HASH (recovery fix):', normalized);
            }

            // Cas g√©n√©ral: plusieurs #
            const firstHashIndex = normalized.indexOf('#');
            if (firstHashIndex !== -1) {
                const afterFirstHash = normalized.substring(firstHashIndex + 1);
                if (afterFirstHash.includes('#')) {
                    const parts = normalized.split('#');
                    normalized = '#' + parts.slice(1).join('&');
                    console.debug('‚úÖ NORMALIZED HASH (multiple # fix):', normalized);
                }
            }

            return normalized;
        }

        function parseNormalizedHash(rawHash) {
            const normalizedHash = normalizeHash(rawHash);

            const search = normalizedHash.startsWith('#')
                ? normalizedHash.slice(1)
                : normalizedHash;

            const params = new URLSearchParams(search);

            const result = {
                type: params.get('type') || '',
                accessToken: params.get('access_token') || '',
                refreshToken: params.get('refresh_token') || '',
                tokenHash: params.get('token_hash') || '',
                expiresAt: params.get('expires_at') || '',
                expiresIn: params.get('expires_in') || '',
                tokenType: params.get('token_type') || ''
            };

            console.debug('üîç PARSED VALUES:', {
                type: result.type,
                hasAccessToken: !!result.accessToken,
                accessTokenLength: result.accessToken.length,
                hasRefreshToken: !!result.refreshToken,
                refreshTokenLength: result.refreshToken.length,
                hasTokenHash: !!result.tokenHash,
                expiresAt: result.expiresAt,
                expiresIn: result.expiresIn,
                tokenType: result.tokenType
            });

            return result;
        }

        // Test personnalis√©
        function testCustomHash() {
            const hash = document.getElementById('customHash').value;
            const resultDiv = document.getElementById('customResult');

            if (!hash) {
                resultDiv.innerHTML = '<div class="result error">‚ùå Entre un hash √† tester</div>';
                return;
            }

            console.clear();
            console.log('=== TEST CUSTOM HASH ===');

            const parsed = parseNormalizedHash(hash);

            let html = '<div class="result success">';
            html += '<div class="log-line log-debug">üîß Hash Original: <code>' + hash + '</code></div>';
            html += '<div class="log-line log-success">‚úÖ Parsing R√©ussi</div>';
            html += '<br><strong>Valeurs Pars√©es:</strong><br>';

            html += '<div class="parsed-value"><span class="parsed-key">type:</span><span class="parsed-val">"' + parsed.type + '"</span></div>';
            html += '<div class="parsed-value"><span class="parsed-key">accessToken:</span><span class="parsed-val">' + (parsed.accessToken ? '"' + parsed.accessToken.substring(0, 30) + '..."' : '(vide)') + '</span></div>';
            html += '<div class="parsed-value"><span class="parsed-key">refreshToken:</span><span class="parsed-val">' + (parsed.refreshToken ? '"' + parsed.refreshToken.substring(0, 30) + '..."' : '(vide)') + '</span></div>';
            html += '<div class="parsed-value"><span class="parsed-key">expiresAt:</span><span class="parsed-val">"' + parsed.expiresAt + '"</span></div>';
            html += '<div class="parsed-value"><span class="parsed-key">expiresIn:</span><span class="parsed-val">"' + parsed.expiresIn + '"</span></div>';
            html += '<div class="parsed-value"><span class="parsed-key">tokenType:</span><span class="parsed-val">"' + parsed.tokenType + '"</span></div>';

            html += '</div>';

            resultDiv.innerHTML = html;
        }

        // Charger un exemple
        function loadExample(num) {
            const input = document.getElementById('customHash');

            switch(num) {
                case 1:
                    input.value = '#type=recovery#access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&expires_at=1735658799&expires_in=3600&refresh_token=abc123def456&token_type=bearer';
                    break;
                case 2:
                    input.value = '#type=recovery&access_token=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9&expires_at=1735658799&expires_in=3600&refresh_token=abc123def456&token_type=bearer';
                    break;
                case 3:
                    input.value = '#type=recovery#access_token=token123#refresh_token=refresh456';
                    break;
            }

            testCustomHash();
        }

        // Tests automatiques
        function runAllTests() {
            console.clear();
            console.log('=== RUNNING ALL TESTS ===');

            const tests = [
                {
                    name: 'Hash avec double # (cas Supabase)',
                    input: '#type=recovery#access_token=eyJhbGciOi&refresh_token=abc123',
                    expected: { type: 'recovery', hasTokens: true }
                },
                {
                    name: 'Hash correct (un seul #)',
                    input: '#type=recovery&access_token=eyJhbGciOi&refresh_token=abc123',
                    expected: { type: 'recovery', hasTokens: true }
                },
                {
                    name: 'Hash vide',
                    input: '',
                    expected: { type: '', hasTokens: false }
                },
                {
                    name: 'Hash avec type=signup',
                    input: '#type=signup&access_token=token123',
                    expected: { type: 'signup', hasTokens: true }
                },
                {
                    name: 'Hash avec plusieurs #',
                    input: '#type=recovery#access_token=token#refresh_token=refresh',
                    expected: { type: 'recovery', hasTokens: true }
                }
            ];

            let html = '';
            let passedCount = 0;

            tests.forEach((test, index) => {
                console.log('\n--- Test ' + (index + 1) + ': ' + test.name + ' ---');
                const parsed = parseNormalizedHash(test.input);

                const passed = parsed.type === test.expected.type &&
                              (!!parsed.accessToken || !!parsed.tokenHash) === test.expected.hasTokens;

                if (passed) passedCount++;

                html += '<div class="result ' + (passed ? 'success' : 'error') + '">';
                html += '<div class="log-line">' + (passed ? '‚úÖ' : '‚ùå') + ' <strong>Test ' + (index + 1) + ':</strong> ' + test.name + '</div>';
                html += '<div class="log-line log-debug">Input: <code>' + test.input + '</code></div>';
                html += '<div class="log-line log-info">Type pars√©: "' + parsed.type + '" (attendu: "' + test.expected.type + '")</div>';
                html += '<div class="log-line log-info">Tokens pr√©sents: ' + (!!parsed.accessToken || !!parsed.tokenHash) + ' (attendu: ' + test.expected.hasTokens + ')</div>';
                html += '</div>';
            });

            html = '<div style="margin: 20px 0;"><strong>R√©sultat: ' + passedCount + '/' + tests.length + ' tests pass√©s</strong></div>' + html;

            document.getElementById('autoTestResults').innerHTML = html;
        }
    </script>
</body>
</html>
